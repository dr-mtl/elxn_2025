<!DOCTYPE html>
<html><head lang="en">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Montreal's City Council</title> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://dr-mtl.github.io/elxn_2025/css/style.css">
    <!--Developed by David Rudin for the Montreal Gazette-->
</head>
<body>
<div id="graphic-contain">
    <div id="overlay">
    <h1><span id="chart-title">Montreal's city council</span> is composed of <span class="button-group"><button data-filter=".mayor" class="inline-button">1 mayor</button>, <button data-filter=".borough-mayor" class="inline-button">18 borough mayors</button> and <button data-filter=".cc" class="inline-button">46 city councillors</button></span>. Click on positions, party names, or faces to learn more.</h1>

    <aside>
        <div class="button-group" id="button-hold">
            
        
        </div>
    </aside>
 

    <main id="dotholder" style="position: relative; height: 432px;">


    </main>
  
    </div>
    <div id="modal" class="hide">

        <div class="imagehold">
            <div id="select-image"></div>
        </div>
        <div id="select-info">

        </div>
        <button label="close" title="close" id="close">X</button>

    </div>

</div>

    <script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>


<script>
/***
LOAD csv
***/
var party = "Party"
var role = "Role"
var name = "Name"
var borough = "Borough"
var district = "District"
var image = "Image"
var slug = "Slug"


var data;



function ingestGoogleSheetCSV(googleSheetCSVUrl) {
  Papa.parse(googleSheetCSVUrl, {
    download: true,
    header: true,
    complete: function(results) {
      data = results.data;
      console.log("Parsed data:", data);
      start();
    }
  });
}

$( document ).ready(function() {
    console.log( "ready!" );
    ingestGoogleSheetCSV("https://docs.google.com/spreadsheets/d/e/2PACX-1vQDK_pk0ha12t3iVBeNjtfO6ousSpczkg5ePWoyQl0c1QIFOsA8KwnclLJtxw7A9h43jxc-gsvMkn9A/pub?output=csv");
});

  
    function start(){


        /****
        Get vote shares
        *****/
        var pmshare=0;
        var emshare=0;
        var tmshare=0;
        var othershare=0;
        var uncalled=0;
        for (i=0; i < data.length; i++){
            if(data[i][party] && data[i][name]){
               if(data[i][party] == "Projet Montréal"){
                pmshare++;
                } else if (data[i][party] == "Ensemble Montréal"){
                    emshare++;
                } else if (data[i][party] == "Transition Montréal"){
                    tmshare++;
                } else{
                    othershare++;
                }; 
            }else{uncalled++;}
        };
        console.log('pm: ' + pmshare);
        console.log('em: ' + emshare);
        console.log('tm: ' + tmshare);
        console.log('other: ' + othershare);
        console.log('uncalled: ' + uncalled);

        /*build buttons*/
        buildbuttons();

        function buildbuttons(){
            var buttonhold = document.getElementById('button-hold');
            var buttong ='';
            buttong += '<button class="team-button active is-checked button" data-filter="*"><div class="seat-number">65</div><div class="team-name"><p>Full <br>Council</p></div></button>';

            if(pmshare>emshare){
                buttong += '<button class="team-button pm button" data-filter=".pm"><div class="seat-number">' + pmshare +'</div><div class="team-name"><p>Projet <br>Montréal</p></div></button>';
                buttong += '<button class="team-button em button" data-filter=".em"><div class="seat-number">' + emshare +'</div><div class="team-name"><p>Ensemble Montréal</p></div></button>';
            } else{
                buttong += '<button class="team-button em button" data-filter=".em"><div class="seat-number">' + emshare +'</div><div class="team-name"><p>Ensemble Montréal</p></div></button>';
                buttong += '<button class="team-button pm button" data-filter=".pm"><div class="seat-number">' + pmshare +'</div><div class="team-name"><p>Projet <br>Montréal</p></div></button>';

            };

            if(tmshare>0){
                buttong+= '<button class="team-button tm button" data-filter=".tm"><div class="seat-number">'+ tmshare +'</div><div class="team-name"><p>Transition Montréal</p></div></button>';
            }
            if (othershare>0){
                buttong+='<button class="team-button other button" data-filter=".other"><div class="seat-number">'+ othershare +'</div><div class="team-name"><p>Other</p></div></button>';
            }
            if (uncalled>0){
                buttong+='<button class="team-button uncalled button" data-filter=".uncalled"><div class="seat-number">'+ uncalled +'</div><div class="team-name"><p>Not called</p></div></button>';
            }

            buttonhold.innerHTML += buttong;

        };

        /*build dots*/
        var dotholder =document.getElementById('dotholder');
        var thedots ='';
        for (i=0; i<data.length;i++){

            //check if each race was called
            if(data[i][party] && data[i][name]){
                
                var thisdot=' <div class="person-circle '
                /*assign party class*/
                if(data[i][party] == "Projet Montréal"){
                    thisdot+= 'pm ';
                } else if (data[i][party] == "Ensemble Montréal"){
                    thisdot+='em ';
                } else if (data[i][party] == "Transition Montréal"){
                    thisdot+= 'tm ';
                } else{
                    thisdot+= 'other '
                };

                /*assign role class*/
                if (data[i][role] == "Mayor"){
                    thisdot+= 'mayor'
                } else if (data[i][role] == "Borough mayor"){
                    thisdot+= 'borough-mayor';
                } else{
                    thisdot += 'cc'
                };

                thisdot+= '" name="' + data[i][name] + '" ';

                /*assign party name and voteshare*/
                if(data[i][party] == "Projet Montréal"){
                    thisdot+= 'data-party="Projet Montréal" data-voteshare="' +pmshare +'"';
                } else if (data[i][party] == "Ensemble Montréal"){
                    thisdot+= 'data-party="Ensemble Montréal" data-voteshare="'+emshare+'"';
                } else if (data[i][party] == "Transition Montréal"){
                    thisdot+= 'data-party="Transition Montréal" data-voteshare="'+tmshare+'"';
                } else{
                    /*set other voteshare to 0 so it always shows up last*/
                    thisdot+= 'data-party="'+data[i][party]+'" data-voteshare="0"';
                };

                thisdot+= 'data-role="' + data[i][role]+'" data-borough="'+ data[i][borough]+'" data-district="' +data[i][district]+'" data-slug="'+data[i][slug]+'" style="background-image: url('+data[i][image]+'" data-image="'+ data[i][image]+'"></div>';


                thedots += thisdot;
            };
        };

        dotholder.innerHTML += thedots;

        /****
        ISOTOPE
        ***/
        /*SORTING*/


        /*Select filters*/
        var $grid = $('main').isotope({
                itemSelector: '.person-circle',
                layoutMode: 'fitRows',
                getSortData: {
                    voteshare: '[data-voteshare]',
                    slug: '[data-slug]'
                },
                sortBy: ['voteshare', 'slug'],
                sortAscending: {
                    voteshare: false,
                    slug: true
                }
            });

            $('.button-group').on('click', 'button', function() {
                var filterValue = $(this).attr('data-filter');
                if(filterValue != ".uncalled"){
                    $grid.isotope({ filter: filterValue });
                }
                
            });

            $('.button-group').each(function(i, buttonGroup) {
                var $buttonGroup = $(buttonGroup);
                $buttonGroup.on('click', 'button', function() {
                    var filterValue = $(this).attr('data-filter');
                    if(filterValue != ".uncalled"){
                        $buttonGroup.find('.is-checked').removeClass('is-checked');
                        $(this).addClass('is-checked');
                    }                    
                });
            });

    /***
    MODAL
    ***/

    $('.person-circle').click(function(){

        var name = $(this).attr('name');
        var party = $(this).attr('data-party');        
        var image = $(this).attr('data-image');
        var borough = $(this).attr('data-borough');
        var district = $(this).attr('data-district');
        var role = $(this).attr('data-role')[0].toLowerCase() + $(this).attr('data-role').slice(1) // sets first letter to lowercase so it works in a sentence

       

        function markparty(){
            if (party == "Projet Montréal"){
                return("<mark class='pm-highlight'>"+party+"</mark>");
            } else if (party == "Ensemble Montréal"){
                return("<mark class='em-highlight'>"+party+"</mark>");
            }else if (party=="Transition Montréal"){
                return("<mark class='tm-highlight'>"+party+"</mark>");
            }else{
                return(party)
            }
        }

        var sentence = "";
        if (role == "mayor"){
            var sentence = "<p><span class='select-name'>" + name + "</span> of " + markparty() + " has been elected Mayor of Montreal.</p><br><p>Montreal's mayor also serves as Ville Marie's borough mayor.</p>"
        } else if (district.length > 1){
            var sentence = "<p><span class='select-name'>" + name + "</span> of " + markparty() + " has been elected as the " +role+ " for the district of " + district+" in the " + borough + " borough.</p>"
        }else if (role == "borough mayor"){
            var sentence = "<p><span class='select-name'>" + name + "</span>  of " + markparty() + " has been elected as the " +role+ " for "+borough+".</p>"

        }else{
            var sentence = "<p><span class='select-name'>" + name + "</span>  of " + markparty() + " has been elected as the " +role+ " in the "+borough+" borough.</p>"
        }

        document.getElementById('select-info').innerHTML = sentence;
        document.getElementById('select-image').innerHTML = '<img src="' + image + '">';
        showoverlay();


    });

    function showoverlay(){
        $('#modal').removeClass("hide");
        $('#overlay').css('pointer-events', 'none');
        //delay change to number long enough to not have click event listener block modal opening
        function Delay() {
        clicked+=1;
        }
        setTimeout(Delay, 10);
    }

    function removeoverlay(){
        $('#modal').addClass("hide");
        $('#overlay').css('pointer-events', '');
        clicked-=1;
    }

    //close overlay
    $('#close').click(function(){
        removeoverlay();
    });

    //close overlay with esc key
    $(document).keyup(function(e) {
    if (e.keyCode === 27) {
        if(!$('#modal').hasClass("hide")){
            removeoverlay();
            }
        }
    });

    var clicked = 0;

    //close overlay by clicking outside of it
    document.addEventListener('click', function(event) {
        const targetDiv = document.getElementById('modal');

        //only bother if modal is open 
        if(!$('#modal').hasClass("hide") && clicked ==1){
            if (targetDiv && !targetDiv.contains(event.target)) {
            // The click occurred outside the targetDiv
            removeoverlay();
            console.log("close")
            }
         } 
    });

    /*THIS IS THE END OF EVERYTHING*/
    };

    
</script>


</body></html>
